<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cable-member</title>
    <script src="/{$Think.Config.template.view_path}assets/js/vue.js"></script>
    <link rel="stylesheet" href="/{$Think.Config.template.view_path}assets/css/antd.min.css">
    <script src="/{$Think.Config.template.view_path}assets/js/axios.min.js"></script>
    <script src="/{$Think.Config.template.view_path}assets/js/antd.min.js"></script>
</head>
<body>
<div id="app">
    <a-table :columns="columns" :data-source="data" bordered>
        <template v-for="col in ['name', 'type', 'description']" :slot="col" slot-scope="text, record, index">
            <div :key="col">
                <a-col v-if="record.editable != true">{{text}}</a-col>
                <a-input v-if="record.editable === true" style="margin: -5px 0" :value="text" @change="e => handleChange(e.target.value, record.id, col)"/>
            </div>
        </template>
        <template slot="type" slot-scope="text, record, index">
            <a-col v-if="record.editable != true">{{filters[text-1].value}}</a-col>
            <a-select v-if="record.editable === true" :disabled="!record.editable" :default-value="filters[text-1].value" style="width: 120px" @change="selectChange($event, record.id, 'type')">
                <a-select-option v-for="item in filters" :value="item.id">{{item.value}}</a-select-option>
            </a-select>
        </template>
        <template slot="operation" slot-scope="text, record, index">
            <div class='editable-row-operations'>
        <span v-if="record.editable">
          <a @click="() => save(record.id)">保存</a>
          <a-popconfirm title='确实要取消?' @confirm="() => cancel(record.id)">
            <a>取消</a>
          </a-popconfirm>
        </span>
                <span v-else>
          <a @click="() => edit(record.id)">编辑</a>
        </span>
            </div>
        </template>
    </a-table>
</div>
</body>
<script>
    const columns = [{
        title: '关键词',
        dataIndex: 'name',
        width: '25%',
        scopedSlots: { customRender: 'name' },
    }, {
        title: '分类',
        dataIndex: 'type',
        width: '15%',
        scopedSlots: { customRender: 'type' },
    }, {
        title: '描述',
        dataIndex: 'description',
        width: '40%',
        scopedSlots: { customRender: 'description' },
    }, {
        title: '操作',
        dataIndex: 'operation',
        scopedSlots: { customRender: 'operation' },
    }]
    const data = []

    var app = new Vue({
        el: "#app",
        data() {
            this.cacheData = data.map(item => ({ ...item }))
            return {
                data,
                columns,
                filters:""
            }
        },
        //初始化
        mounted() {
            this.get()
        },
        //方法
        methods: {
            handleChange (value, key, column) {
                const newData = [...this.data]
                const target = newData.filter(item => key === item.id)[0]
                if (target) {
                    target[column] = value
                    this.data = newData
                }
            },
            selectChange (event, key, column){
                console.log(typeof event)
                const newData = [...this.data]
                const target = newData.filter(item => key === item.id)[0]
                if (target) {
                    target[column] = event
                    this.data = newData
                }
            },
            edit (key) {
                console.log("edit:"+key);
                const newData = [...this.data]
                const target = newData.filter(item => key === item.id)[0]
                if (target) {
                    target.editable = true
                    this.data = newData
                }
            },
            save (key) {
                const newData = [...this.data]
                console.log(newData);
                const target = newData.filter(item => key === item.id)[0]
                console.log(target)
                axios.post("/member/manage/update",{...target}).then(function (response) {
                    if (response.status){
                        if (response.data.status){
                            app.$message.loading('保存中..', 0.5)
                                .then(() => app.$message.success(response.data.message, 1.5))
                        }else{
                            app.$message.loading('保存中..', 0.5)
                                .then(() => app.$message.info(response.data.message, 1.5))
                        }
                    }
                }).catch()
                if (target) {
                    delete target.editable
                    this.data = newData
                    this.cacheData = newData.map(item => ({ ...item }))
                }
            },
            cancel (key) {
                const newData = [...this.data]
                const target = newData.filter(item => key === item.id)[0]
                if (target) {
                    Object.assign(target, this.cacheData.filter(item => key === item.id)[0])
                    delete target.editable
                    this.data = newData
                }
            },
            get() {
                axios.post("/member/manage/get").then(function (response) {
                    if (response.status){
                        app.data = response.data.results;
                        app.filters = response.data.filters;
                    }
                }).catch()
            }
        },
    })
</script>
<style>
    #components-layout-demo-custom-trigger .trigger {
        font-size: 18px;
        line-height: 64px;
        padding: 0 24px;
        cursor: pointer;
        transition: color .3s;
    }

    #components-layout-demo-custom-trigger .trigger:hover {
        color: #1890ff;
    }

    #components-layout-demo-custom-trigger .logo {
        height: 32px;
        background: rgba(255,255,255,.2);
        margin: 16px;
    }
</style>
<style>
    #components-layout-demo-custom-trigger .trigger {
        font-size: 18px;
        line-height: 64px;
        padding: 0 24px;
        cursor: pointer;
        transition: color .3s;
    }

    #components-layout-demo-custom-trigger .trigger:hover {
        color: #1890ff;
    }

    #components-layout-demo-custom-trigger .logo {
        height: 32px;
        background: rgba(255,255,255,.2);
        margin: 16px;
    }
    #components-layout-demo-custom-trigger {
        height: 100vh;
    }
</style>
<style>
    body{
        overflow: hidden;
    }
</style>
</html>
